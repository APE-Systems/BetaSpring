"use strict";function propagateGroupDelete(e,t){function n(e){console.log("deleteCoachGroup");var n={school:e.sess.school,"groups.name":e.name},i={$pull:{groups:{name:e.name}}};e.Mods.Coaches.update(n,i,function(n,i){if(n)return t(n,null);console.log("coach:\n",i);r(e);return})}function r(e){console.log("deleteTeamGroup");var n={school:e.sess.school,name:e.team.name,gender:e.team.gender,"groups.name":e.name},r={$pull:{groups:{name:e.name}}};e.Mods.Teams.update(n,r,function(n,r){if(n)return t(n,null);console.log("team:\n",r);i(e);return})}function i(e){console.log("deleteAthleteGroup");var n={school:e.sess.school,team:e.team,"groups.name":e.name},r={$pull:{groups:{name:e.name}}};e.Mods.Athletes.update(n,r,{multi:!0},function(n,r){if(n)return t(n,null);console.log("athlete:\n",r);return t(null,e.doc)})}console.info("propagating delGroup");n(e)}function propagateGroupUpdate(e,t){function n(e){console.log("updateCoachGroup");var n={school:e.sess.school,"groups.name":e.oldGroup},i={$set:{"groups.$.name":e.newGroup}};e.Mods.Coaches.findOneAndUpdate(n,i,function(n,i){if(n)return t(n,null);console.log("coaches:\n",i.groups);r(e)})}function r(e){console.log("updateTeamGroup");var n={school:e.sess.school,name:e.team.name,gender:e.team.gender,"groups.name":e.oldGroup},r={$set:{"groups.$.name":e.newGroup}};e.Mods.Teams.findOneAndUpdate(n,r,function(n,r){if(n)return t(n,null);console.log("team:\n",r.groups);i(e)})}function i(e){console.log("updateAthleteGroup");var n={school:e.sess.school,"coaches.username":e.sess.username,"coaches.name":e.sess.name,"groups.name":e.oldGroup},r={$set:{"groups.$.name":e.newGroup}};e.Mods.Athletes.update(n,r,{multi:!0},function(n,r){if(n)return t(n,null);console.log("athletes:",r);t(null,e.doc)})}console.info("propagating upGroup");n(e)}function propagateGroupCreate(e,t){function n(e){console.log("insertCoachGroup");var n={school:e.sess.school,username:e.sess.username,"teams.name":e.team.name,"teams.gender":e.team.gender},i={$push:{groups:{_id:e.doc._id,name:e.doc.name}}};e.Mods.Coaches.findOneAndUpdate(n,i,function(n,i){if(n)return t(n,null);console.log("coach:\n",i.groups);return r(e)})}function r(e){console.log("insertTeamGroup");var n={school:e.sess.school,name:e.team.name,gender:e.team.gender},r={$push:{groups:{_id:e.doc._id,name:e.doc.name}}};e.Mods.Teams.findOneAndUpdate(n,r,function(n,r){if(n)return t(n,null);console.log("team:\n",r.groups);return t(null,e.doc)})}console.info("propagating newGroup");return n(e)}function validateInput(e,t){console.log("Operations: validateInput");var n=45,r=/^[_]*[a-zA-Z0-9][a-zA-Z0-9 _.-]*$/;if(n===e.length){console.info("Validation: Error\n");var i={name:"ValidationError",msg:"Input exceeds number of characaters allowed",code:422};return t(i,null)}if(!r.test(e)){console.info("Validation: Error\n");var i={name:"ValidationError",msg:"Not valid input",code:422};return t(i,null)}console.info("Validation: Success\n");return t(null,e)}function getAthletes(e,t){var n={},r=e.models,i=e.sess.school,s={name:e.params.team,gender:e.params.gender},o=e.sess.username,u={school:i,team:s,"coaches.username":o},a={name:1,positions:1,years:1,metrics:1};r.Athletes.find(u,a,function(e,r){e&&t(e,null);n.athletes=r;t(n)})}function getAPElib(e){return function(t){var n={},r={},i={name:1,metrics:1};APE.MetricCats.find(r,i,function(r,i){r&&e(r,null);n.mtrcats=i;APE.Metrics.find({"mtrcats.name":{$exists:!1}},{name:1},function(r,i){r&&e(r,null);n.metrics=i;t.apeLibPackage=n;return e(null,t)})})}}var APE=require("../models/db/config").apeMods,rostersPageOps={getRostersPage:function(e,t){console.log("Operation: getRostersPage");getAthletes(e,getAPElib(t))},createAthlete:function(e,t){console.log("Operation: createAthlete");var n={name:e.params.team,gender:e.params.gender},r=e.school,i=e.models,s=new i.Athletes;s.createdBy=e.sess.COID;s.school=r;s.name=e.body.name;s.gender=e.body.gender;s.save(function(e){t(e)})},updateAthlete:function(e,t){console.log("Operation: updateTeam");var n=e.models,r=e.school,i={name:e.params.team},s={name:e.body.name,gender:e.body.gender};n.Teams.findOneAndUpdate(i,s,function(e,n){e&&t(e);console.log("teamUpdate:",s);t(null)})},deleteAthlete:function(e,t){console.log("Operation: deleteTeam");var n=e.models,r=e.school;n.Teams.findOneAndRemove(cond,function(e,n){e&&t(e);console.log("teamDelete:",n);t(null)})},createGroup:function(e,t){function n(n,r){if(n)return t(n,null);var i={name:e.params.group,team:{name:e.params.team,gender:e.params.gender},sess:e.sess,Mods:e.models},s=new i.Mods.Groups;s.createdBy=i.sess.COID;s.school=i.sess.school;s.team=i.team;s.name=i.name;console.log("create ",s.name);s.save(function(e){if(e)return t(e,null);console.log("crGroup:",s.name);i.doc=s;propagateGroupCreate(i,t)})}console.log("Operation: createGroup");validateInput(e.params.group,n)},updateGroup:function(e,t){function n(n,r){if(n)return t(n,null);var i={newGroup:e.body.upName,oldGroup:e.params.oldGroup,team:{name:e.params.team,gender:e.params.gender},sess:e.sess,Mods:e.models};console.log("replace "+i.oldGroup+" with "+i.newGroup);var s={school:i.sess.school,team:i.team,name:i.oldGroup},o={$set:{name:i.newGroup}};i.Mods.Groups.findOneAndUpdate(s,o,function(e,n){if(e)return t(e,null);console.log("upGroup:\n",n.name);i.doc=n;propagateGroupUpdate(i,t)})}console.log("Operation: updateGroup");validateInput(e.params.oldGroup,n)},deleteGroup:function(e,t){function n(n,r){if(n)return t(n,null);var i={name:e.params.group,team:{name:e.params.team,gender:e.params.gender},sess:e.sess,Mods:e.models};console.log("delete "+i.name);var s={school:i.sess.school,team:i.team,name:i.name};i.Mods.Groups.findOneAndRemove(s,function(e,n){if(e)return t(e,null);console.log("delGroup:\n",n);i.doc=n;propagateGroupDelete(i,t)})}console.log("Operation: deleteGroup");validateInput(e.params.group,n)}};module.exports=exports=rostersPageOps;