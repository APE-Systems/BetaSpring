"use strict";function insertCoachesTeam(e,t,n){var r=e.models,i={school:t.school},s={$push:{teams:{_id:t._id,name:t.name,gender:t.gender}}};r.Coaches.update(i,s,{multi:!0},n)}function insertSchoolTeam(e,t){var n={name:e.school},r={$push:{teams:{_id:e._id,name:e.name,gender:e.gender}}};APE.Schools.update(n,r,t)}function validateInput(e,t){console.log("Operations: validateInput\n");var n=45,r=/^[_]*[a-zA-Z0-9][a-zA-Z0-9 _.-]*$/;if(n===e.length){var i={name:"ValidationError",msg:"Input exceeds number of characaters allowed",code:422};return t(i,null)}if(!r.test(e)){var i={name:"ValidationError",msg:"Not valid input",code:422};return t(i,null)}console.info("Validation: Success");return t(null,e)}function getTeams(e,t){var n={},r=e.models,i=e.sess.school,s=e.sess.username,o={school:i,"coaches.username":s},u={name:1,gender:1,mtrcats:1,metrics:1};r.Teams.find(o,u,function(e,r){e&&t(e,null);n.teams=r;t(n)})}function getAPElib(e){return function(t){var n={},r={},i={name:1,metrics:1};APE.MetricCats.find(r,i,function(r,i){r&&e(r,null);n.mtrcats=i;APE.Metrics.find({"mtrcats.name":{$exists:!1}},{name:1},function(r,i){r&&e(r,null);n.metrics=i;t.apeLibPackage=n;return e(null,t)})})}}function propagateUpdate(e,t,n){function o(t){var n={name:e.sess.school,"teams.name":e.params.team,"teams.gender":e.params.gender},r={$set:{"teams.$.name":t.name,"teams.$.gender":t.gender}};APE.Schools.update(n,r,function(e,n,r){if(e)throw new Error(e);console.info("Updated: School",n,r);u(t);return})}function u(e){var t={$set:{"teams.$.name":e.name,"teams.$.gender":e.gender}};r.Coaches.update(i,t,{multi:!0},function(t,n,r){if(t)throw new Error(t);console.info("Updated: Coaches",n,r);a(e);return})}function a(e){var t={$set:{"teams.$.name":e.name,"teams.$.gender":e.gender}};r.Metrics.update(i,t,{multi:!0},function(t,n,r){if(t)throw new Error(t);console.info("Updated: Metrics",n,r);f(e);return})}function f(e){var t={$set:{team:{name:e.name,gender:e.gender}}};r.MetricCats.update(s,t,{multi:!0},function(t,n,r){if(t)throw new Error(t);console.info("Updated: Metric Categories",n,r);l(e);return})}function l(e){var t={$set:{team:{name:e.name,gender:e.gender}}};r.Athletes.update(s,t,{multi:!0},function(t,n,r){if(t)throw new Error(t);console.info("Updated: Athletes",n,r);c(e);return})}function c(e){var t={$set:{team:{name:e.name,gender:e.gender}}};r.Groups.update(s,t,{multi:!0},function(e,t,r){if(e)throw new Error(e);console.info("Updated: Groups",t,r);n(null);return})}var r=e.models,i={school:e.sess.school,"teams.name":e.params.team,"teams.gender":e.params.gender},s={school:e.sess.school,"team.name":e.params.team,"team.gender":e.params.gender};o(t)}function propagateDelete(e,t,n){function i(t){var n={name:e.sess.school,"teams.name":e.params.team,"teams.gender":e.params.gender};APE.Schools.update(n,function(e,n){if(e)throw new Error(e);console.info("Deleted: School\n",n);s(t);return})}function s(e){r.Coaches.update()}function o(e){r.Metrics.update()}function u(e){r.MetricCats.update()}function a(e){}function f(e){}var r=e.models;i(t)}var APE=require("../models/db/config").apeMods,teamsPageOps={getTeamsPage:function(e,t){console.log("Operation: getTeamsPage");getTeams(e,getAPElib(t))},createTeam:function(e,t){function n(n,r){if(n)return t(n,null);var i=e.models,s=e.sess.school,o=new i.Teams;o.createdBy=e.sess.COID;o.coaches.push({_id:e.sess.COID,username:e.sess.username,name:e.sess.name});o.school=s;o.name=r;o.gender=e.params.gender;o.save(function(n){if(n)return t(n,null);insertSchoolTeam(o,function(n,r){if(n)return t(n,null);console.info("Team saved in School\n",r);insertCoachesTeam(e,o,function(e,n){if(e)return t(e,null);console.info("Team saved in coaches\n",n);t(null,o)})})})}console.log("Operation: createTeam");validateInput(e.params.team,n)},updateTeam:function(e,t){function i(n,i){if(n)return t(n,null);var s=e.models,o=e.sess.school,u={name:e.params.team,gender:e.params.gender},a={$set:{name:i,gender:r}};s.Teams.findOneAndUpdate(u,a,{"new":!0},function(n,r){n&&t(n);console.log("teamUpdated:\n",r.name,r.gender);propagateUpdate(e,r,t);return})}console.log("Operation: updateTeam");var n=e.body["team-name"],r=e.body["team-gender"];validateInput(n,i)},deleteTeam:function(e,t){console.log("Operation: deleteTeam");var n,r,i,s;n=e.models;r=e.sess.school;e.sess.username;i={name:e.params.team,gender:e.params.gender,"coaches.username":s};n.Teams.findOneAndRemove(i,function(n,r){n&&t(n);console.log("teamDelete:",r);propagateDelete(e,delDoc,t);t(null)})}};module.exports=exports=teamsPageOps;