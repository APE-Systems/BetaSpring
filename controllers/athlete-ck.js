function getModelMetricValue(e,t,n){var r={};for(var i=0;i<e.length;i++){var s=e[i].model,o=e[i].keys,u={};for(var a=0;a<o.length;a++){var f=t[s][o[a]].sort(dtSort);f[0]&&(f[0].val.replace(/[ a-zA-Z\*\(\)]/g,"")!==""?u[o[a]]=f[0].val.replace(/[ a-zA-Z\*\(\)]/g,""):u[o[a]]="--")}r[s]=u}n(r)}function bundle(e,t,n){var r,i,s,o,u={};mLen=e.length;aLen=t.length;for(var a=0;a<mLen;a++){s=e[a].model;u[s]={};for(var f=0;f<aLen;f++){mLabel=t[f].label;e[a].keys.indexOf(mLabel)!=-1&&(u[s][mLabel]=isNaN(Math.round(t[f].avg*100)/100)?t[f].avg:Math.round(t[f].avg*100)/100)}}n(u)}function getAthleteById(e,t,n){Athlete.findById(t,"fullname teams school position group year metrics",function(t,r){if(t){console.error("\n----ERROR----");console.error("getAthleteById query(_id):\n"+t);console.error("-------------");return e.redirect("/internal_error/athlete.getAthleteById/"+t.code+"/")}n(r)})}function getAthleteMetric(e,t,n,r){e.Metric.findById(n.metrics,function(e,n){if(e){console.error("\n----ERROR----");console.error("getAthleteMetric query(_id):\n"+e);console.error("-------------");return t.redirect("/internal_error/athlete.getAthleteMetric/"+e.code+"/")}r(n)})}function getModelMetrics(e,t,n,r,i){var s=[],o={};for(var u=0;u<n.length;u++){var a=n[u].model,f=n[u].keys;(function(u,a){var f=a.join(" ");e[u].findOne({MID:r._id},f,function(e,r){if(e){console.error("\n----ERROR----");console.error("getAthleteBioMetric query(MID):\n"+e);console.error("-------------");return t.redirect("/internal_error/athlete.getAthleteBioMetric/"+e.code+"/")}o[u]=r;s.push(o);s.length===n.length&&i(o)})})(a,f)}}function getChartMetric(e,t,n,r,i,s){i[n].findOne({AID:t},r,function(e,t){t=t[r].sort(dtSort);cleanData(t,function(e){s(e)})})}function tSort(e,t){return e<t?1:e>t?-1:0}function dtSort(e,t){return e.dt<t.dt?1:e.dt>t.dt?-1:0}function latestRecord(e,t,n){School.findOne({name:e},function(e,r){t.RecordTime.find({},{time:1},function(e,t){if(e)throw e;t=t[0].time.sort(tSort);n(t[0])})})}function cleanData(e,t){var n,r,i=[],s=[],o={};for(r=0;r<e.length;r++){n=e[r].val.replace(/[a-zA-Z\*\(\)]/g,"");if(n!==""){i.push(moment(e[r].dt).format("MMM DD YYYY"));s.push(n)}}o={values:s.reverse(),labels:i.reverse()};t(o)}var Athlete=require("../models").Athletes,School=require("../models").Schools,stats=require("../middleware").stats,filter=require("../middleware").dbHits,moment=require("moment"),labels={bioHT:"Body Height (in)",bioBW:"Body Weight (lbs)",bioBF:"Body Fat (%)",bioBFsf:"Body Fat-SF (%)",reach:"Reach (in)",appToHt:"Approach Touch Height (in)",appVJ:"Approach Vertical Jump (in)",stVJ:"Standing Vertical Jump (in)",stVJToHt:"Standing Vertical Jump Touch (in)",pwVJ:"Vertical Jump (in)",pwLJ:"Long Jump (in)",pwFJht:"Four Jump (ht)",pwFJgct:"Four Jump (gct)",brdJ:"Broad Jump",SquJump40:"40% Squat Jump (pp)",SquJump20:"20k Squat Jump (watts)",medBall:"Medicine Ball (ft)",tenyds:"10 YDS (sec)",twnyds:"20 YDS (sec)",thtyds:"30 YD Sprint (avg)",frtyds:"40 YD Sprint (sec)",thrhdyds:"300 YD Shuttle (sec)",fvmbk:"Five Mile Bike (time)",hm1h:"Home-1st (sec-hand)",hm1e:"Home-1st (sec-elec)",hm2:"Home-2nd (sec)",hh:"H-H (sec-hand)",hmr1:"1/2 Mile (rep 1)",hmr2:"1/2 Mile (rep 2)",hmavg:"1/2 Miles (avg)",proAgL:"Pro Agility L (sec)",proAgR:"Pro Agility R (sec)",proAgLa:"Pro Agility L (avg)",proAgRa:"Pro Agility R (avg)",cl:"Clean (lbs)",cldf:"Clean Deadlift (lbs)",pcl:"Power Clean (lbs)",hgpcl:"Hang Power Clean (lbs)",hgcl:"Hang Clean (lbs)",hgsn:"Hang Snatch (lbs)",sn:"Snatch (lbs)",hgpsn:"Hang Power Snatch (lbs)",hgclsh:"Hang Clean Shrug (lbs)",squ:"Squat (lbs)",bsq:"Back Squat (lbs)",fsq:"Front Squat (lbs)",dsq:"Deep Sq (reps)",bp:"Bench Press (lbs)",pjk:"Push Jerk (lbs)",spjk:"Split Jerk (lbs)",sngdf:"Snatch Grip Deadlift (lbs)",ir:"Inv. Row (reps)",pu:"Pull Ups (reps)",chup:"Chin Ups (reps)",hstp:"Hurdle Step (reps)",illg:"IL Lunge (reps)",shmob:"SH Mob",aslr:"ASLR (reps)",stbpu:"Stability PU (reps)",rtstb:"Rot Stability (reps)",wgpk:"Wingate Peak (watts)",wgrel:"Wingate Relative (watts/lbs)"};module.exports.get=function(e,t){console.info("\n\r---------------------");console.log("AJAX: get athlete by ID:",e.params.id);console.info("---------------------");var n=e.models,r=e.params.id,i=e.user.school.replace(/ /g,"");getAthleteById(t,r,function(n){filter.Metrics(e,t,r,function(e){var r={};for(var i in e)e[i][0]&&(r[Object.keys(e[i][0])[0]]=labels[Object.keys(e[i][0])[0]]);console.log("return AJAX");t.json({athlete:n,Metrics:e,labels:r})})})};module.exports.profile=function(e,t){console.info("\n\r---------------------");console.log("Date:",new Date);console.log("user:",e.fullname);console.log("get athlete profile:",e.params.id,"\n");console.info("---------------------");var n=[],r=e.user.school,i=e.models,s=e.params.id;latestRecord(r,i,function(e){console.log("latestRecord Done");getAthleteById(t,s,function(e){console.log("getAthleteById Done");stats.getAverage(r,i,e.teams[0],function(o,u){console.log("profile metrics\n",o);bundle(o,u,function(u){console.log("averages\n",u);stats.getDelta(r,s,i,function(s){console.log("deltas\n",s);getAthleteMetric(i,t,e,function(a){getModelMetrics(i,t,o,a,function(i){getModelMetricValue(o,i,function(i){console.log("metricValues\n",i);for(var a=0;a<o.length;a++){var f=o[a].model,l=o[a].keys,c={},h={averages:u[f],deltas:s[f]};for(var p=0;p<l.length;p++)h[l[p]]=i[f][l[p]];c[f]=h;n.push(c)}if(n.length===o.length){console.log("render profile");t.render("profile",{athletes:[e],school:r,Metrics:n,labels:labels})}})})})})})})})})};module.exports.getChart=function(e,t){var n,r,i,s;n=e.params.id;r=e.params.metric;i=e.params.el;s=e.models;console.info("\n\r---------------------");console.log('AJAX: get athlete ID: ObjectId("'+n+'")');console.log("AJAX: get athlete metric:",r);console.log("AJAX: get athlete element:",i);console.info("---------------------");getChartMetric(t,n,r,i,s,function(e){console.log("chartData",e);t.json(e)})};