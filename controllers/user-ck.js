// var Athlete = require('../models').Athletes
//   , Coach = require('../models').Coaches
//   , Session = require('../models').Sessions
//   , filter = require('../middleware').dbHits;
function getModelMetrics(e,t,n,r,i){n=n||{};r=r||{};r instanceof Array&&(r=r.join(" "));e[t].find(n,r,function(e,t){if(e)throw e;return i(t)})}function getAllAthletes(e,t){Athlete.find({teams:{$in:[e]}},"fullname teams school position group year",function(e,n){if(e)throw e;console.log("  number of athletes",n.length+"\n");return t(n)})}function endSession(e,t){var n=e.date;Session.remove({_id:e._id},function(e,r){if(e){console.error("\n----ERROR----");console.error("session remove(sessionId):\n"+e);console.error("-------------");return res.redirect("/internal_error/process.endSession/"+e.code+"/")}t(n)})}function alphaSortNames(e,t){return e.fullname.split(" ")[1]<t.fullname.split(" ")[1]?-1:e.fullname.split(" ")[1]>t.fullname.split(" ")[1]?1:0}function alphaSort(e,t){return e<t?-1:e>t?1:0}function dtSort(e,t){return e.dt<t.dt?1:e.dt>t.dt?-1:0}function getTeamModelsLabels(e,t,n){var r=[];for(var i in t)i!="RecordTime"&&i!="Metric"&&r.push(i);console.log("user:models",r);return n(r)}function getModelMetricsLabels(e,t,n){var r=["_id","__v","SID","MID","AID","teams"],i=[];for(var s in e[t].schema.paths)r.indexOf(s.toString())===-1&&i.push(s);console.log("user:metrics",i);return n(i)}var labels={bioHT:"Body Height (in)",bioBW:"Body Weight (lbs)",bioBF:"Body Fat (%)",bioBFsf:"Body Fat-SF (%)",reach:"Reach (in)",appToHt:"Approach Touch Height (in)",appVJ:"Approach Vertical Jump (in)",stVJ:"Standing Vertical Jump (in)",stVJToHt:"Standing Vertical Jump Touch (in)",pwVJ:"Vertical Jump (in)",pwLJ:"Long Jump (in)",pwFJht:"Four Jump (ht)",pwFJgct:"Four Jump (gct)",brdJ:"Broad Jump",SquJump40:"40% Squat Jump (pp)",SquJump20:"20k Squat Jump (watts)",medBall:"Medicine Ball (ft)",tenyds:"10 YDS (sec)",twnyds:"20 YDS (sec)",thtyds:"30 YD Sprint (avg)",frtyds:"40 YD Sprint (sec)",thrhdyds:"300 YD Shuttle (sec)",fvmbk:"Five Mile Bike (time)",hm1h:"Home-1st (sec-hand)",hm1e:"Home-1st (sec-elec)",hm2:"Home-2nd (sec)",hh:"H-H (sec-hand)",hmr1:"1/2 Mile (rep 1)",hmr2:"1/2 Mile (rep 2)",hmavg:"1/2 Miles (avg)",proAgL:"Pro Agility L (sec)",proAgR:"Pro Agility R (sec)",proAgLa:"Pro Agility L (avg)",proAgRa:"Pro Agility R (avg)",cl:"Clean (lbs)",cl1rm:"Clean 1RM (lbs)",cl2rm:"Clean 2RM (lbs)",cl3rm:"Clean 3RM (lbs)",cldf1rm:"Clean Deadlift 1RM (lbs)",cldf2rm:"Clean Deadlift 2RM (lbs)",cldf3rm:"Clean Deadlift 3RM (lbs)",pcl:"Power Clean (lbs)",pcl1rm:"Power Clean 1RM (lbs)",pcl2rm:"Power Clean 2RM (lbs)",pcl3rm:"Power Clean 3RM (lbs)",hgpcl:"Hang Power Clean (lbs)",hgpcl1rm:"Hang Power Clean 1RM (lbs)",hgpcl2rm:"Hang Power Clean 2RM (lbs)",hgpcl3rm:"Hang Power Clean 3RM (lbs)",hgcl:"Hang Clean (lbs)",hgsn:"Hang Snatch (lbs)",hgsn1rm:"Hang Snatch 1RM (lbs)",hgsn2rm:"Hang Snatch 2RM (lbs)",hgsn3rm:"Hang Snatch 3RM (lbs)",sn:"Snatch (lbs)",sn1rm:"Snatch 1RM (lbs)",sn2rm:"Snatch 1RM (lbs)",sn3rm:"Snatch 1RM (lbs)",hgpsn:"Hang Power Snatch (lbs)",hgpsn1rm:"Hang Power Snatch 1RM (lbs)",hgpsn2rm:"Hang Power Snatch 2RM (lbs)",hgpsn3rm:"Hang Power Snatch 3RM (lbs)",hgclsh:"Hang Clean Shrug (lbs)",squ:"Squat (lbs)",bsq:"Back Squat (lbs)",bsq1rm:"Back Squat 1RM (lbs)",bsq2rm:"Back Squat 2RM (lbs)",bsq3rm:"Back Squat 3RM (lbs)",fsq:"Front Squat (lbs)",dsq:"Deep Sq (reps)",bp:"Bench Press (lbs)",pjk1rm:"Push Jerk 1RM (lbs)",pjk2rm:"Push Jerk 2RM (lbs)",pjk3rm:"Push Jerk 3RM (lbs)",spjk1rm:"Split Jerk 1RM (lbs)",spjk2rm:"Split Jerk 2RM (lbs)",spjk3rm:"Split Jerk 3RM (lbs)",sngdf1rm:"Snatch Grip Deadlift 1RM (lbs)",sngdf2rm:"Snatch Grip Deadlift 2RM (lbs)",sngdf3rm:"Snatch Grip Deadlift 3RM (lbs)",ir:"Inv. Row (reps)",pu:"Pull Ups (reps)",chup:"Chin Ups (reps)",hstp:"Hurdle Step (reps)",illg:"IL Lunge (reps)",shmob:"SH Mob",aslr:"ASLR (reps)",stbpu:"Stability PU (reps)",rtstb:"Rot Stability (reps)",wgpk:"Wingate Peak (watts)",wgrel:"Wingate Relative (watts/lbs)"};module.exports.logout=function(e,t,n){console.info("\n\r---------------------");console.info("logging out");console.info("---------------------");endSession(e.session,function(e){var n=new Date;t.clearCookie(".APEAUTH");console.info("  cookie cleared");console.info("  logout dateTime:",n);console.info("  time spent:",(n-e)/1e3,"secs");t.redirect("/login")})};module.exports.dashboard=function(e,t){console.info("\n\r---------------------");console.info("render dashboard");console.info("---------------------");t.render("dashboard",{username:e.user.fullname,school:e.user.school,teams:e.user.teams})};module.exports.rosters=function(e,t){console.info("\n\r---------------------");console.info("render roster");console.info("---------------------");var n=e.user.school,r=e.user.teams.sort(alphaSort);getAllAthletes(r[0],function(i){filter.Metrics(e,t,i[0]._id,function(e){t.render("rosters",{athletes:i,school:n,teams:r,Metrics:e,labels:labels})})})};module.exports.training=function(e,t){console.info("\n\r---------------------");console.info("render training");console.info("---------------------");var n=e.user.username,r=e.user.school,i=e.user.teams.sort(alphaSort),s=["All"],o=e.models,u={};getAllAthletes(i[0],function(e){e=e.sort(alphaSortNames);getTeamModelsLabels(i[0],o,function(n){n=n.sort(alphaSort);getModelMetricsLabels(o,n[0],function(a){a=a.sort(alphaSort);var f={teams:i[0]},l="AID "+a[0];getModelMetrics(o,n[0],f,l,function(o){var f={},l={};for(var c in a)u[a[c]]=labels[a[c]];for(var h in o){var p=o[h],d=p.AID,v=p[a[0]];if(v.length>0){var m=p[a[0]].sort(dtSort)[0].val,g=p[a[0]].sort(dtSort)[0]._id;m=m.replace(/[ a-zA-Z\*\(\)]/g,"");f[d]=m!==""?m:"--";l[d]=g}else{l[d]="";f[d]="--"}}console.log("objLabels",u);t.render("training",{athletes:e,school:r,teams:i,groups:s,models:n,metricLabels:u,lastValues:f,dataId:l})})})})})};